# 작업 정리 (2025-10-22)

## 개요
- 한국 주식 데이터 기반 실험 파이프라인을 정비하고 자동화.
- 지표 정의와 데이터 생성 로직을 재작성해 누락값 없이 일관된 피처 세트를 확보.
- 5개 에이전트(A2C/DDPG/PPO/TD3/SAC) + 앙상블 전략을 스크립트로 일괄 학습/평가.
- 모든 산출물을 실험명 기준 폴더에 정리하고 단일 로그 파일로 기록.

---

## 데이터 생성/지표
- `build_kis_dataset.py`
  - 프리페치 252영업일로 롤링 지표 누락 제거.
  - 지표 구성: `sma_10`, `sma_30`, `disparity_25`, `rsi`, `macd/macd_signal/macd_hist`, `bollinger_upper/lower`, `stochastic_oscillator`, `atr`.
  - `day`: 요일이 아닌 누적 거래일 인덱스(0..). 학습 피처로는 사용하지 않아도 분석에 활용 가능.
  - `VIX`/`turbulence` 계산: 
    - `yfinance`에서 VIX 수집, MultiIndex 헤더 평탄화 후 캐시(`data/vix_daily.csv`) 저장.
    - turbulence는 날짜별로 계산 후 캐시(`data/turbulence_daily.csv`) 저장.
  - 지표가 완전히 채워진 앞부분만 남기고, 초단기 상장 등으로 누락이 뜨는 종목은 제거(최종 28종목).
  - CSV 저장 시 index 제외.

- 생성 산출물(`data/`):
  - `kis_full_data.csv`, `train_data.csv`, `stock_test_data.csv`, `trade_data.csv`, `backtest_data.csv`
  - `vix_daily.csv`, `turbulence_daily.csv`

---

## 설정 변경
- `config.py`
  - 분할 기간: Train(2023-01-02 → 2024-12-30), Test(2025-01-02 → 2025-04-29), Trade(2025-05-02 → 2025-08-29)
  - 지표 리스트: `["macd","macd_signal","macd_hist","bollinger_upper","bollinger_lower","rsi","stochastic_oscillator","disparity_25","atr","sma_10","sma_30"]`
  - `MY_TICKER`: 완전 이력 보유 28개로 축소(초단기 종목 제외).

---

## 학습/평가 파이프라인
- `scripts/run_experiment.py`
  - 실행: `python -m scripts.run_experiment --experiment-name <실험명>`
  - 5개 에이전트 학습 → 트레이드 백테스트 → 앙상블 전략 실행 → 시각화/로그 저장.
  - 모든 산출물은 `experiments/<실험명>/` 아래 정리:
    - `models/`: 에이전트 체크포인트(zip)
    - `sb3_logs/`: SB3 로거 출력
    - `results/`: CSV 출력(행동/계좌/앙상블 요약 등)
    - `plots/`: 트레이드/앙상블 성과 그래프 PNG
    - `logs/experiment.log`: 표준출력/경고까지 통합된 단일 로그
  - 옵션:
    - `--timesteps-scale`: 전체 학습스텝 스케일(예: 0.1은 리허설)
    - `--turbulence-threshold`: 트레이드 환경 임계값(기본 70)
  - 보정: 테스트 구간이 짧을 때 앙상블 `rebalance/validation` 윈도우 자동 조정.
  - 베이스라인: yfinance로 KOSPI(`^KS11`) 다운로드 시도(실패시 경고만 출력, 실험은 계속 진행).

- `models.py` / `env.py`
  - 산출물 경로를 `config.RESULTS_DIR`로 일원화.
  - TensorBoard 미설치 환경에서도 동작하도록 안전 처리.
  - 검증/트레이드 단계 결과 CSV/PNG를 일괄 저장.

---

## 리포 정리/문서화
- `.gitignore` 추가: `experiments/` 산출물, 캐시/바이너리 제외. `experiments/.gitkeep` 유지.
- `README.md` 추가: 실행법/폴더 구조/데이터 생성 가이드.
- 실험 중 생성되던 비정상 상대경로(`./mnt/...`) 디렉터리 제거 및 재발 방지(로깅 리디렉션 개선).

---

## 실행 예시
```bash
# 데이터 재구성 (config 기간으로 실행)
python build_kis_dataset.py

# 충분한 학습으로 5개 모델 + 앙상블 실행
python -m scripts.run_experiment --experiment-name trial_01

# 빠른 검증용(스텝 10%):
python -m scripts.run_experiment --experiment-name dryrun --timesteps-scale 0.1
```

---

## 알려진 경고/주의
- yfinance 베이스라인: `YahooDownloader`와 yfinance의 MultiIndex 컬럼 불일치로
  "Length mismatch" 경고가 발생할 수 있음(비교 그래프만 비활성화되고 학습/백테스트엔 영향 없음).
  필요 시 baseline 로직 평탄화 보완 예정.
- `pyfolio` 미설치 시 상세 백테스트 통계(`ensemble_backtest_stats.csv`)는 생략됨.
- SB3가 MLP 정책에서 GPU 경고를 출력할 수 있음(경고이며 실행에는 영향 없음).

---

## 폴더 구조(요약)
- `build_kis_dataset.py` : 데이터 수집/전처리/지표/캐시 → `data/`
- `config.py` : 실험 기간/지표/종목/하이퍼파라미터
- `data/` : CSV(Train/Test/Trade/Backtest, Full, VIX/Turbulence 캐시)
- `env.py` : 강화학습 환경, 결과물 저장 로직
- `helper_function.py` : 유틸(지표/분할/베이스라인/백테스트)
- `models.py` : 에이전트/앙상블 학습·검증·트레이드
- `scripts/run_experiment.py` : 실험 오케스트레이션(에이전트 5종 + 앙상블)
- `experiments/<실험명>/` : 실험 산출물(models/sb3_logs/results/plots/logs)
- `README.md` : 실행법/폴더 구조/데이터 가이드
- `.gitignore`, `experiments/.gitkeep`

---

## 다음 단계 제안
- baseline(yfinance) MultiIndex 호환 처리 개선 또는 KRX 지수 로컬 캐시 도입.
- pyfolio 설치 후 상세 통계 자동화.
- 실험 파라미터 스위프(슬라이딩 윈도우, 수수료/슬리피지 시나리오) 스크립트화.

